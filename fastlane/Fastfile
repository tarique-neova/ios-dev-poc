default_platform :ios
platform :ios do

  before_all do
    setup_circle_ci
  end

  lane :use_cert do
      app_store_connect_api_key(
        key_id: "WXYFK8CF5D",
        issuer_id: "6701bcf4-21c5-4e25-9fd7-76af487a8e20",
        key_content: "-----BEGIN PRIVATE KEY-----\nMIGTAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBHkwdwIBAQQgz8S6G+oCbY+DlpDO44h91CyqPHc1f1hDIvO90XyVyi+gCgYIKoZIzj0DAQehRANCAATRh6sKuK3JunOpDqvb1xdkwZ3kbmiAueV/XaTNdZ/JNlbOW33ikt7yrA9jCDoukR0mqh1PisbBdCXuqJmmAkcC\n-----END PRIVATE KEY-----"
      )
      match(
        type: "development",
        readonly: false,
        force_for_new_devices: false,
        app_identifier: "com.neovasolutions.ios-dev-poc",
        git_url: "https://github.com/tarique-neova/ios-dev-poc.git",
      )

      match(
        type: "appstore",
        readonly: false,
        force_for_new_devices: false,
        app_identifier: "com.neovasolutions.ios-dev-poc",
        git_url: "https://github.com/tarique-neova/ios-dev-poc.git",
      )
  end       
  
  lane :build_release do |options|
  
        app_identifier = "com.neovasolutions.ios-dev-poc"
       
        profile_name = "match Development com.neovasolutions.ios-dev-poc"
        output_name = "neovapoc.ipa" 
        export_method = "app-store" 
       
        update_code_signing_settings(
          use_automatic_signing: true,
          targets: ["ios-dev-poc"], 
          code_sign_identity: "Apple Distribution", 
          bundle_identifier: app_identifier,
          profile_name: profile_name,
          build_configurations: ["Release"],
          path: "./ios-dev-poc.xcodeproj",
          team_id: "2ZBVR8AP3W"
  
        )
       
        gym(
          scheme: "ios-dev-poc", # replace with name of your project’s scheme
          output_name: output_name,
          configuration: "Release",
          # export_options: {
          #   method: export_method,
          #   provisioningProfiles: {
          #     app_identifier => profile_name # here you can add any additional bundle identifiers and their associated provisioning profiles if you’re also building an app extension or other bundle identifier
          #   }
          # }
        )
  end  
end
  